cmake_minimum_required(VERSION 3.13.3)
# 项目信息
project (jelog C CXX)
# 指定cpp版本
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED true)

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY "${PROJECT_BINARY_DIR}")
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY "${PROJECT_BINARY_DIR}")
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY "${PROJECT_BINARY_DIR}")
set(CMAKE_INSTALL_PREFIX ${PROJECT_BINARY_DIR})

option(BUILD_SHARED_LIBS "Build using shared libraries" ON)

if(MSVC)
    add_definitions(-D_CRT_SECURE_NO_WARNINGS)
    add_compile_options(/utf-8 /MT)
endif()

add_library(${PROJECT_NAME} STATIC log.cpp)

# target_include_directories(${PROJECT_NAME} PUBLIC
#                            "${PROJECT_SOURCE_DIR}"
#                            )

install(FILES "${PROJECT_SOURCE_DIR}/log.h"
  DESTINATION include/
  )

# export
install(TARGETS ${PROJECT_NAME} 
  EXPORT ${PROJECT_NAME}Targets
  DESTINATION lib)

# 安装
install(EXPORT ${PROJECT_NAME}Targets
  FILE ${PROJECT_NAME}Targets.cmake
  DESTINATION lib/cmake/${PROJECT_NAME}
)

target_include_directories(${PROJECT_NAME}
  INTERFACE
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
    $<INSTALL_INTERFACE:include>
)

# 使其在构建和安装目录中使用不同路径
include(CMakePackageConfigHelpers)
configure_package_config_file(${CMAKE_CURRENT_SOURCE_DIR}/Config.cmake.in
  "${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}Config.cmake"
  INSTALL_DESTINATION "lib/cmake/${PROJECT_NAME}"
  NO_SET_AND_CHECK_MACRO
  NO_CHECK_REQUIRED_COMPONENTS_MACRO
)
write_basic_package_version_file(
  "${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake"
  VERSION "${PROJECT_VERSION_MAJOR}.${PROJECT_VERSION_MINOR}"
  COMPATIBILITY AnyNewerVersion
)

# 将生成的配置和版本安装到适当位置
install(FILES
  ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}Config.cmake
  ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake
  DESTINATION lib/cmake/${PROJECT_NAME}
)

# 生成${PROJECT_NAME}Targets.cmake
export(EXPORT ${PROJECT_NAME}Targets
  FILE "${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}Targets.cmake"
)

# 测试选项
if(BUILD_TESTING) 
    aux_source_directory(test/ TEST_DIR)  
    add_executable(log_test log.cpp ${TEST_DIR})

    # install后可这样使用
    # SET(CMAKE_PREFIX_PATH ${PROJECT_BINARY_DIR})
    # find_package(${PROJECT_NAME} REQUIRED)
    # target_link_libraries(log_test PRIVATE ${PROJECT_NAME})
    # 不install时
    # target_link_libraries(log_test PRIVATE ${PROJECT_BINARY_DIR}/lib/${PROJECT_NAME})

    # include(CTest)
    enable_testing()
    add_test(NAME LogTest COMMAND log_test)
endif()
